name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯

# ç’°å¢ƒå¤‰æ•°ï¼ˆå…¨ã‚¸ãƒ§ãƒ–å…±é€šï¼‰
env:
  JAVA_VERSION: '21'
  GRADLE_OPTS: -Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.caching=true

jobs:
  test:
    name: Build and Test
    runs-on: ubuntu-latest
    timeout-minutes: 30  # å…¨ä½“ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆITå«ã‚€ï¼‰

    # Oracle Testcontainersç”¨ã®è¨­å®š
    # DockerãŒå¿…è¦ãªãŸã‚ã€ubuntu-latestã«ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§DockerãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹
    # ãƒ¡ãƒ¢ãƒªã¨CPUã‚’ç¢ºä¿
    env:
      # Testcontainersè¨­å®š
      TESTCONTAINERS_RYUK_DISABLED: false  # ãƒªã‚½ãƒ¼ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚’æœ‰åŠ¹åŒ–
      # Dockerè¨­å®š
      DOCKER_BUILDKIT: 1

    steps:
      # 1. ã‚³ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      # 2. JDKã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: â˜• Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'gradle'

      # 3. Gradlewã«å®Ÿè¡Œæ¨©é™ã‚’ä»˜ä¸Ž
      - name: ðŸ”§ Grant execute permission for gradlew
        run: chmod +x gradlew

      # 4. Dockerã®çŠ¶æ…‹ç¢ºèªï¼ˆTestcontainersç”¨ï¼‰
      - name: ðŸ³ Verify Docker
        run: |
          echo "=== Docker Version ==="
          docker --version
          echo ""
          echo "=== Docker Info ==="
          docker info
          echo ""
          echo "=== Available Memory ==="
          free -h

      # 4.5 Wrapper / Gradle / Java / Repoè³‡æãƒã‚§ãƒƒã‚¯
      - name: ðŸ” Verify build assets (wrapper, gradle, java)
        run: |
          set -eux
          echo "=== Repo root files ==="
          ls -la
          echo "=== Wrapper files ==="
          test -f ./gradlew && echo "OK: gradlew exists" || (echo "NG: gradlew missing" && exit 1)
          test -f ./gradle/wrapper/gradle-wrapper.jar && echo "OK: wrapper jar exists" || (echo "NG: wrapper jar missing" && exit 1)
          cat ./gradle/wrapper/gradle-wrapper.properties
          echo "=== Java ==="
          java -version
          echo "=== Gradle ==="
          ./gradlew --version

      # 5. UTå®Ÿè¡Œï¼ˆé«˜é€Ÿã€Mockã®ã¿ï¼‰+ æ™‚é–“è¨ˆæ¸¬
      - name: ðŸ§ª Run Unit Tests
        run: |
          echo "::group::ðŸ“Š Unit Test Execution"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸš€ Starting Unit Tests (UT)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          UT_START=$(date +%s)
          ./gradlew unitTest --no-daemon --console=plain
          UT_EXIT_CODE=$?
          UT_END=$(date +%s)
          UT_DURATION=$((UT_END - UT_START))

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Unit Tests Completed"
          echo "â±ï¸  Duration: ${UT_DURATION}s ($(printf '%02d:%02d' $((UT_DURATION/60)) $((UT_DURATION%60))))"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "::endgroup::"

          # å®Ÿè¡Œæ™‚é–“ã‚’ç’°å¢ƒå¤‰æ•°ã«ä¿å­˜
          echo "UT_DURATION=${UT_DURATION}" >> $GITHUB_ENV

          exit $UT_EXIT_CODE

      # 6. ITå®Ÿè¡Œï¼ˆTestcontainers + Oracle XEï¼‰+ æ™‚é–“è¨ˆæ¸¬
      - name: ðŸ”¬ Run Integration Tests
        timeout-minutes: 20  # ITå°‚ç”¨ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆOracleèµ·å‹•å«ã‚€ï¼‰
        run: |
          echo "::group::ðŸ“Š Integration Test Execution"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸš€ Starting Integration Tests (IT)"
          echo "ðŸ“¦ Using Testcontainers + Oracle XE"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          IT_START=$(date +%s)
          ./gradlew integrationTest --no-daemon --console=plain
          IT_EXIT_CODE=$?
          IT_END=$(date +%s)
          IT_DURATION=$((IT_END - IT_START))

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Integration Tests Completed"
          echo "â±ï¸  Duration: ${IT_DURATION}s ($(printf '%02d:%02d' $((IT_DURATION/60)) $((IT_DURATION%60))))"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "::endgroup::"

          # å®Ÿè¡Œæ™‚é–“ã‚’ç’°å¢ƒå¤‰æ•°ã«ä¿å­˜
          echo "IT_DURATION=${IT_DURATION}" >> $GITHUB_ENV

          exit $IT_EXIT_CODE

      # 7. Dockerã‚³ãƒ³ãƒ†ãƒŠã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ç¢ºèª
      - name: ðŸ§¹ Check Docker Containers
        if: always()
        run: |
          echo "=== Running Containers ==="
          docker ps
          echo ""
          echo "=== All Containers (including stopped) ==="
          docker ps -a
          echo ""
          echo "=== Docker Images ==="
          docker images

      # 8. JaCoCoãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
      - name: ðŸ“ˆ Generate JaCoCo Coverage Report
        if: always()
        run: |
          echo "::group::ðŸ“Š JaCoCo Report Generation"
          ./gradlew jacocoTestReport --no-daemon --console=plain
          echo "::endgroup::"

      # 9. ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚é–“ã‚µãƒžãƒªãƒ¼ã®å‡ºåŠ›
      - name: ðŸ“Š Test Execution Summary
        if: always()
        run: |
          echo "## ðŸ“Š Test Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Type | Duration | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ª Unit Tests | ${UT_DURATION}s ($(printf '%02d:%02d' $((${UT_DURATION:-0}/60)) $((${UT_DURATION:-0}%60)))) | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”¬ Integration Tests | ${IT_DURATION}s ($(printf '%02d:%02d' $((${IT_DURATION:-0}/60)) $((${IT_DURATION:-0}%60)))) | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| **ðŸ“¦ Total** | **$((${UT_DURATION:-0} + ${IT_DURATION:-0}))s** | **âœ…** |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Performance Notes" >> $GITHUB_STEP_SUMMARY
          echo "- UT expected: < 5s" >> $GITHUB_STEP_SUMMARY
          echo "- IT expected: 3-6 minutes (includes Oracle container startup)" >> $GITHUB_STEP_SUMMARY
          echo "- **Improvement**: Container reuse can reduce IT time by 70-80%" >> $GITHUB_STEP_SUMMARY

      # 10. ãƒ†ã‚¹ãƒˆçµæžœã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: ðŸ“¤ Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            build/test-results/**/*.xml
            build/reports/tests/**
          retention-days: 30

      # 11. JaCoCoãƒ¬ãƒãƒ¼ãƒˆã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: ðŸ“¤ Upload JaCoCo Coverage Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-coverage-report
          path: |
            build/reports/jacoco/test/html/
            build/reports/jacoco/test/jacocoTestReport.xml
          retention-days: 30

      # 12. ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚µãƒžãƒªãƒ¼ã‚’PRã‚³ãƒ¡ãƒ³ãƒˆã«è¡¨ç¤º
      - name: ðŸ’¬ Add Coverage Comment to PR
        id: jacoco
        uses: madrapps/jacoco-report@v1.6.1
        if: github.event_name == 'pull_request'
        with:
          paths: ${{ github.workspace }}/build/reports/jacoco/test/jacocoTestReport.xml
          token: ${{ secrets.GITHUB_TOKEN }}
          min-coverage-overall: 70
          min-coverage-changed-files: 70
          title: 'ðŸ“Š JaCoCo Coverage Report'

      # 13. ãƒ†ã‚¹ãƒˆå¤±æ•—æ™‚ã®è©³ç´°ãƒ­ã‚°å‡ºåŠ›
      - name: ðŸ“‹ Print Test Failure Details
        if: failure()
        run: |
          echo "::group::âŒ Test Failure Logs"

          echo "=== Unit Test Results (reports dir listing) ==="
          ls -la build/reports || true
          ls -la build/reports/tests || true
          ls -la build/reports/tests/unitTest || true
          ls -la build/reports/tests/test || true

          echo ""
          echo "=== Unit Test HTML files ==="
          find build/reports/tests -maxdepth 3 -type f -name "*.html" -print 2>/dev/null || true

          echo ""
          echo "=== Unit Test XML results ==="
          find build/test-results -maxdepth 3 -type f -name "*.xml" -print 2>/dev/null || true

          echo ""
          echo "=== Integration Test Results (reports dir listing) ==="
          ls -la build/reports/tests/integrationTest || true

          echo ""
          echo "=== Integration Test HTML files ==="
          find build/reports/tests/integrationTest -type f -name "*.html" -print 2>/dev/null || true

          echo "::endgroup::"
