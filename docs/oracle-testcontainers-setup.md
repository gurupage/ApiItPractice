# Oracle Testcontainers + Flyway セットアップ

## 1. Oracleイメージの選定理由

### 選定イメージ: `gvenzl/oracle-xe:21-slim`

**選定理由:**

1. **公式対応**: Testcontainers公式がサポートしているOracle XE用の推奨イメージ
2. **軽量**: `slim`タグにより不要なコンポーネントを削減（約2.5GB vs 通常版の5GB+）
3. **起動速度**: Oracle公式イメージに比べて起動が高速（30-60秒 vs 2-5分）
4. **ライセンス**: Oracle XEは無料で開発・テストに利用可能
5. **メンテナンス**: Gerald Venzl氏（Oracle社員）が積極的にメンテナンス
6. **互換性**: Oracle Database 21c XEをベースにしており、本番環境との互換性が高い

**他の選択肢との比較:**

| イメージ | サイズ | 起動時間 | メリット | デメリット |
|---------|--------|----------|----------|-----------|
| `gvenzl/oracle-xe:21-slim` | ~2.5GB | 30-60秒 | 軽量・高速・メンテナンス良好 | XEの機能制限あり |
| `gvenzl/oracle-free:23-slim` | ~2.8GB | 40-70秒 | Oracle 23c対応、最新機能 | まだ新しいため安定性は劣る |
| `container-registry.oracle.com/database/express:21.3.0-xe` | ~5GB | 2-5分 | Oracle公式 | 巨大・起動遅い |
| `wnameless/oracle-xe-11g-r2` | ~2GB | 60-90秒 | 古くから使われている | 古すぎる（11g）、非推奨 |

## 2. 現在の構成（改善前）

### 2.1 設計方針

**わざと非効率な構成にしている理由:**

テストクラスごとにコンテナを再起動する設計にすることで、後で最適化する際の改善効果を実感できる教材として機能します。

```java
@Container
static OracleContainer oracleContainer = new OracleContainer("gvenzl/oracle-xe:21-slim")
        .withDatabaseName("testdb")
        .withUsername("testuser")
        .withPassword("testpass")
        .withReuse(false);  // ← わざと再利用しない
```

### 2.2 問題点

- **起動時間**: テストクラスごとにコンテナ起動（30-60秒）
- **リソース**: 複数テストクラス実行時にメモリを大量消費
- **CI/CD**: パイプラインの実行時間が長くなる

### 2.3 現在のテスト実行フロー

```
TestClassA実行
  ├─ Oracleコンテナ起動（30-60秒）
  ├─ Spring Context構築（10-20秒）
  ├─ Flyway Migration実行（5-10秒）
  ├─ テスト実行（数秒）
  └─ コンテナ停止・破棄

TestClassB実行
  ├─ Oracleコンテナ起動（30-60秒）← 再度起動！
  ├─ Spring Context構築（10-20秒）
  ├─ Flyway Migration実行（5-10秒）
  ├─ テスト実行（数秒）
  └─ コンテナ停止・破棄
```

**合計**: テストクラス数 × （起動時間 + 実行時間）

## 3. ファイル構成

```
src/
├── main/
│   └── resources/
│       ├── application.yml               # 本番・ローカル開発用設定
│       └── db/migration/
│           └── V1__create_task_table.sql # Flywayマイグレーション
└── test/
    ├── java/
    │   └── com/example/apipractice/
    │       └── integration/
    │           ├── config/
    │           │   └── TestcontainersConfig.java  # Testcontainers共通設定
    │           ├── infrastructure/
    │           │   └── TaskRepositoryIntegrationTest.java
    │           └── api/
    │               └── TaskApiIntegrationTest.java
    └── resources/
        └── application-test.yml          # テスト用設定
```

## 4. Flyway Migration

### V1__create_task_table.sql

```sql
CREATE TABLE tasks (
    id NUMBER(19) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    title VARCHAR2(255) NOT NULL,
    description CLOB,
    status VARCHAR2(50) DEFAULT 'TODO' NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL
);

CREATE INDEX idx_tasks_status ON tasks(status);
CREATE INDEX idx_tasks_created_at ON tasks(created_at);
```

**ポイント:**
- Oracle固有の`NUMBER(19)`と`VARCHAR2`を使用
- `GENERATED BY DEFAULT AS IDENTITY`でAuto Increment
- `CLOB`で大きなテキストを格納

## 5. 設定ファイル

### application.yml (本番・ローカル開発用)

```yaml
spring:
  datasource:
    url: jdbc:oracle:thin:@localhost:1521/XEPDB1
    username: system
    password: oracle
    driver-class-name: oracle.jdbc.OracleDriver

  jpa:
    hibernate:
      ddl-auto: validate  # Flywayに任せる
    properties:
      hibernate:
        dialect: org.hibernate.dialect.OracleDialect

  flyway:
    enabled: true
    baseline-on-migrate: true
    locations: classpath:db/migration
```

### application-test.yml (テスト用)

```yaml
spring:
  datasource:
    # Testcontainersが@DynamicPropertySourceで動的設定

  jpa:
    hibernate:
      ddl-auto: validate
    show-sql: true

  flyway:
    enabled: true
    clean-on-validation-error: true  # テスト時は検証エラーでクリーン
```

## 6. TestcontainersConfig

```java
@Testcontainers
public abstract class TestcontainersConfig {

    @Container
    static OracleContainer oracleContainer = new OracleContainer("gvenzl/oracle-xe:21-slim")
            .withDatabaseName("testdb")
            .withUsername("testuser")
            .withPassword("testpass")
            .withReuse(false);  // 改善前: わざと再利用しない

    @DynamicPropertySource
    static void setDatasourceProperties(DynamicPropertyRegistry registry) {
        registry.add("spring.datasource.url", oracleContainer::getJdbcUrl);
        registry.add("spring.datasource.username", oracleContainer::getUsername);
        registry.add("spring.datasource.password", oracleContainer::getPassword);
        registry.add("spring.datasource.driver-class-name", () -> "oracle.jdbc.OracleDriver");
    }
}
```

**ポイント:**
- `@Container static`: JUnit 5の拡張機能でコンテナライフサイクル管理
- `@DynamicPropertySource`: Spring起動前に接続情報を動的設定
- `withReuse(false)`: 明示的に再利用を無効化（教材用）

## 7. 統合テストの書き方

```java
@SpringBootTest
@ActiveProfiles("test")
@Tag("integration")
@Transactional  // テスト後にロールバック
class TaskRepositoryIntegrationTest extends TestcontainersConfig {

    @Autowired
    private TaskRepository taskRepository;

    @Test
    void タスクを保存して取得できる() {
        // given
        Task task = Task.create("Test Task", "Description");

        // when
        Task saved = taskRepository.save(task);

        // then
        assertThat(saved.getId()).isNotNull();
        assertThat(saved.getTitle()).isEqualTo("Test Task");
    }
}
```

**ポイント:**
- `extends TestcontainersConfig`: Oracleコンテナを継承
- `@ActiveProfiles("test")`: application-test.ymlを使用
- `@Tag("integration")`: `./gradlew integrationTest`で実行可能
- `@Transactional`: テスト後に自動ロールバック（データクリーンアップ）

## 8. テスト実行

```bash
# 統合テストのみ実行
./gradlew integrationTest

# 単体テストのみ実行
./gradlew unitTest

# すべてのテスト実行
./gradlew test

# CI用（全テスト + カバレッジ）
./gradlew ci
```

## 9. 次のステップ（改善案）

現在の構成の問題点を改善する方法については、別ドキュメント `oracle-testcontainers-optimization.md` を参照してください。

改善により期待できる効果:
- テスト実行時間: **70-80%削減** (例: 5分 → 1分)
- メモリ使用量: **50%削減**
- CI/CDパイプライン: **大幅な時間短縮**
